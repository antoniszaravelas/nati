<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pilates Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#f7f8fb;
      --card:#ffffff;
      --ink:#20242a;
      --muted:#64748b;
      --accent:#4f46e5;
      --accent-2:#10b981;
      --ring:rgba(79,70,229,.35);
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:18px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0f1217;
        --card:#11161d;
        --ink:#e5e7eb;
        --muted:#9aa4b2;
        --ring:rgba(99,102,241,.4);
        --shadow:0 10px 30px rgba(0,0,0,.55);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 10% -10%, rgba(79,70,229,.08), transparent 60%),
                  radial-gradient(1000px 500px at 110% 10%, rgba(16,185,129,.08), transparent 60%), var(--bg);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
    }

    .wrap{
      width:100%;
      max-width:560px;
      position:relative;
    }

    /* Decorative geometry */
    .geo{
      position:absolute; inset:-40px -40px auto auto; width:160px; height:160px; opacity:.35; filter:blur(.2px);
      pointer-events:none; animation: float 8s ease-in-out infinite;
    }
    .geo.bottom{
      inset:auto auto -50px -50px; transform:rotate(8deg); animation-delay:1.2s;
    }
    @keyframes float{
      0%,100%{ transform:translateY(0) rotate(0); }
      50%{ transform:translateY(-8px) rotate(2deg); }
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.35)) , var(--card);
      backdrop-filter:saturate(1.2) blur(6px);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:24px;
      position:relative; overflow:hidden;
      border:1px solid rgba(100,116,139,.12);
      animation: pop .55s cubic-bezier(.16,1,.3,1);
    }
    @keyframes pop{
      from{transform:translateY(6px) scale(.98); opacity:0}
      to{transform:translateY(0) scale(1); opacity:1}
    }

    h1{
      font-size: clamp(24px, 3.5vw, 32px);
      line-height:1.15;
      margin:0 0 8px;
      letter-spacing:.2px;
    }
    .subtitle{
      color:var(--muted);
      margin:0 0 18px;
      font-size:clamp(14px,2.6vw,16px);
    }

    form{
      display:grid; gap:12px;
    }
    label{
      font-size:14px; color:var(--muted);
      display:block; margin:6px 0 6px;
    }
    input[type="text"], input[type="date"], select, button{
      width:100%;
      font-size:16px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(100,116,139,.25);
      background:rgba(255,255,255,.7);
      color:var(--ink);
      outline:none;
      transition:border-color .2s, box-shadow .2s, transform .05s;
    }
    input:focus, select:focus, input[type="date"]:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 6px var(--ring);
    }
    .row{
      display:grid; gap:12px;
      grid-template-columns:1fr 1fr;
    }
    @media (max-width:520px){ .row{ grid-template-columns:1fr; } }

    button{
      border:none;
      background:linear-gradient(135deg,var(--accent), #7c3aed);
      color:#fff;
      font-weight:700;
      letter-spacing:.2px;
      cursor:pointer;
      margin-top:6px;
      position:relative;
      isolation:isolate;
    }
    button:hover{ transform: translateY(-1px); }
    button:active{ transform: translateY(0); }
    button:disabled{
      opacity:.6; cursor:not-allowed; transform:none;
      background:linear-gradient(135deg,#6b7280,#4b5563);
    }

    .note{
      font-size:13px; color:var(--muted); margin-top:6px;
    }
    .message{
      margin-top:14px; font-weight:600;
      display:flex; align-items:center; gap:10px;
    }
    .message.error{ color:#ef4444; }
    .message.success{ color:var(--accent-2); }

    /* Animated check */
    .check{
      width:22px; height:22px; border-radius:50%;
      border:2px solid var(--accent-2); position:relative; flex:0 0 auto;
    }
    .check::after{
      content:""; position:absolute; inset:0;
      border-radius:50%; border:2px solid transparent; border-top-color:var(--accent-2);
      animation: spin 1s linear infinite; opacity:.25;
    }
    .check.done::after{ display:none; }
    .tick{
      position:absolute; left:5px; top:3px; width:9px; height:14px;
      border-right:3px solid var(--accent-2); border-bottom:3px solid var(--accent-2);
      transform:rotate(45deg) scale(0); transform-origin:bottom left;
      transition: transform .35s cubic-bezier(.16,1,.3,1) .1s;
    }
    .done .tick{ transform:rotate(45deg) scale(1); }

    /* Tiny helper text */
    .hint{ font-size:12px; color:var(--muted); margin-top:2px; }

    /* Success confetti-ish glow */
    .glow{
      position:absolute; inset:-40px; pointer-events:none; opacity:0; transition:opacity .6s ease;
      background: radial-gradient(300px 300px at 20% 0%, rgba(16,185,129,.18), transparent 60%),
                  radial-gradient(300px 300px at 80% 100%, rgba(79,70,229,.18), transparent 60%);
    }
    .card.success .glow{ opacity:1; }
    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Decorative SVG geometry -->
    <svg class="geo" viewBox="0 0 200 200" aria-hidden="true">
      <defs>
        <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="#4f46e5" stop-opacity=".75"></stop>
          <stop offset="1" stop-color="#10b981" stop-opacity=".75"></stop>
        </linearGradient>
      </defs>
      <path fill="url(#g1)" d="M157 98c0 35-29 72-64 72S28 133 28 98s29-70 65-70 64 35 64 70z" />
      <circle cx="50" cy="30" r="10" fill="#10b981" opacity=".65"/>
      <rect x="120" y="10" width="18" height="18" rx="4" fill="#4f46e5" opacity=".65"/>
    </svg>
    <svg class="geo bottom" viewBox="0 0 200 200" aria-hidden="true">
      <defs>
        <linearGradient id="g2" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="#10b981" stop-opacity=".75"></stop>
          <stop offset="1" stop-color="#4f46e5" stop-opacity=".75"></stop>
        </linearGradient>
      </defs>
      <path fill="url(#g2)" d="M100 10c36 0 64 28 64 64s-28 66-64 66S36 110 36 74 64 10 100 10z"/>
      <circle cx="160" cy="160" r="12" fill="#4f46e5" opacity=".6"/>
    </svg>

    <div id="card" class="card">
      <div class="glow" aria-hidden="true"></div>
      <h1>Pilates Class Booking</h1>
      <p class="subtitle">Choose a <b>Monday</b>, then select <b>18:00</b> or <b>19:00</b>. One booking per person.</p>

      <form id="bookingForm" novalidate>
        <div>
          <label for="name">Your Name</label>
          <input id="name" name="name" type="text" inputmode="text" autocomplete="name" placeholder="e.g., Alex Müller" required />
          <div class="hint">Please use your full name.</div>
        </div>

        <div class="row">
          <div>
            <label for="date">Pick a Monday</label>
            <input id="date" name="date" type="date" required />
            <div id="dateHint" class="hint">Only Mondays are allowed.</div>
          </div>

          <div>
            <label for="slot">Class Time</label>
            <select id="slot" name="slot" required>
              <option value="">— Select a time —</option>
              <option value="18:00">Monday 18:00</option>
              <option value="19:00">Monday 19:00</option>
            </select>
          </div>
        </div>

        <!-- Simple honeypot (hidden field bots might fill) -->
        <input type="text" id="website" name="website" class="hidden" tabindex="-1" autocomplete="off" />

        <button id="submitBtn" type="submit">
          <span id="btnText">Confirm Booking</span>
        </button>

        <div id="msg" class="message" role="status" aria-live="polite"></div>
      </form>
    </div>
  </div>

  <script>
    // ---------- Configuration ----------
    const ENDPOINT = "YOUR_WEB_APP_URL_HERE"; // <— replace with your Google Apps Script Web App URL

    // ---------- Utilities ----------
    const $ = sel => document.querySelector(sel);
    const card = $("#card");
    const form = $("#bookingForm");
    const nameEl = $("#name");
    const dateEl = $("#date");
    const slotEl = $("#slot");
    const msg = $("#msg");
    const submitBtn = $("#submitBtn");
    const btnText = $("#btnText");

    const STORAGE_KEY = "pilates_booking_locked"; // one-time lock per device/browser

    function setMinMonday() {
      const nextMon = getNextMonday();
      const iso = nextMon.toISOString().slice(0,10);
      dateEl.min = iso;
      // Step by 7 days so the date picker jumps Mondays (still validate on change)
      dateEl.step = "7";
      // Pre-fill next Monday if not set
      if (!dateEl.value) dateEl.value = iso;
    }

    function getNextMonday(fromDate = new Date()) {
      const d = new Date(fromDate);
      d.setHours(0,0,0,0);
      const day = d.getDay(); // 0=Sun, 1=Mon
      const diff = (day === 1) ? 7 : ((8 - day) % 7) || 7; // next Monday (not today)
      d.setDate(d.getDate() + diff);
      return d;
    }

    function isMonday(iso) {
      const d = new Date(iso + "T00:00:00");
      return d.getDay() === 1;
    }

    function disableForm(reasonText){
      [...form.elements].forEach(el => el.disabled = true);
      submitBtn.disabled = true;
      form.classList.add("locked");
      msg.className = "message";
      msg.innerHTML = "";
      card.classList.add("success");
      // Show finished state
      const wrap = document.createElement("div");
      wrap.className = "message success";
      wrap.innerHTML = `
        <span class="check done"><i class="tick"></i></span>
        <span>${reasonText || "Booking complete. See you on the mat!"}</span>
      `;
      msg.replaceWith(wrap);
    }

    function showError(text){
      msg.className = "message error";
      msg.innerHTML = `❌ ${text}`;
    }
    function showLoading(text){
      msg.className = "message";
      msg.innerHTML = `<span class="check"><i class="tick"></i></span><span>${text}</span>`;
    }
    function showSuccess(text){
      msg.className = "message success";
      msg.innerHTML = `<span class="check done"><i class="tick"></i></span><span>${text}</span>`;
      card.classList.add("success");
    }

    function alreadyBooked(){
      return localStorage.getItem(STORAGE_KEY) === "1";
    }
    function markBooked(){
      localStorage.setItem(STORAGE_KEY, "1");
    }

    // ---------- Init ----------
    setMinMonday();

    // Enforce Monday on change
    dateEl.addEventListener("change", () => {
      if (dateEl.value && !isMonday(dateEl.value)) {
        showError("Please choose a Monday.");
        dateEl.value = ""; // clear invalid selection
      } else {
        msg.textContent = "";
      }
    });

    // Lock if already booked on this device
    if (alreadyBooked()){
      disableForm("You’ve already booked. Thanks!");
    }

    // ---------- Submit ----------
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (alreadyBooked()){
        showError("This device has already registered.");
        return;
      }

      const name = nameEl.value.trim();
      const date = dateEl.value;
      const slot = slotEl.value;
      const honeypot = $("#website").value;

      if (honeypot) return; // likely a bot

      if (!name || !date || !slot){
        showError("Please fill your name, a Monday date, and a class time.");
        return;
      }
      if (!isMonday(date)){
        showError("Only Mondays are allowed.");
        return;
      }

      // Loading state
      submitBtn.disabled = true;
      btnText.textContent = "Submitting…";
      showLoading("Saving your booking...");

      try{
        const res = await fetch(ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, date, slot })
        });

        // Some Apps Script deployments return text/plain; try to parse safely
        const text = await res.text();
        let data = {};
        try { data = JSON.parse(text); } catch (_) { /* ignore */ }

        if (!res.ok){
          throw new Error(data?.error || "Request failed");
        }

        // Mark local one-time lock
        markBooked();

        // Success UI
        showSuccess("✅ Booking confirmed!");
        btnText.textContent = "Booked";
        disableForm(); // final lock
      }catch(err){
        console.error(err);
        submitBtn.disabled = false;
        btnText.textContent = "Confirm Booking";
        showError("Could not save booking. Please try again.");
      }
    });
  </script>
</body>
</html>
